generator client {
  provider = "prisma-client-js"
}

// Typed enums (new)
enum AppointmentStatus {
  Confirmed
  Pending
  Cancelled
  Completed
}

enum PatientStatus {
  Active
  Inactive
}

// New enum for treatments
enum TreatmentStatus {
  Pending
  InProgress
  Completed
}

enum InvoiceStatus {
  Draft
  Sent
  Paid
  Overdue
  Cancelled
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String
  firstName       String
  lastName        String
  role            UserRole
  permissions     String[]
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime?
  specialization  String?
  licenseNumber   String?
  employeeId      String?
  department      String?
  patientId       String?
  phone           String?
  address         String?
  profileImageUrl String?

  // Optional staff linkage for employees
  staff           Staff?
  
  // User notifications
  notifications   Notification[]
}

model CollectionDoc {
  id         String
  collection String
  data       Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@id([collection, id])
  @@index([collection])
}

// Typed Appointment model
model Appointment {
  id               String            @id @default(uuid())
  dateTime         DateTime
  patient          String
  patientId        String?
  patientEmail     String?
  patientPhone     String?
  doctor           String
  doctorId         String?
  type             String
  duration         String
  status           AppointmentStatus @default(Confirmed)
  treatmentId      String?
  treatment        Treatment?        @relation(fields: [treatmentId], references: [id])
  notes            String?
  bookedBy         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  reason           String?
  urgency          String?
  confirmedAt      DateTime?
  confirmedBy      String?
  rejectedAt       DateTime?
  rejectionReason  String?
  rejectedBy       String?

  @@index([dateTime])
  @@index([status])
  @@index([treatmentId])
}

model Patient {
  id                String        @id @default(uuid())
  name              String
  lastName          String
  email             String        @unique
  phone             String
  dob               DateTime
  lastVisit         DateTime?
  status            PatientStatus @default(Active)
  address           String?
  ecName            String?
  ecPhone           String?
  ecRelationship    String?
  insuranceProvider String?
  policyNumber      String?
  medicalHistory    Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  invoices          Invoice[]
  settings          PatientSettings?

  @@index([status])
  @@index([lastVisit])
}

// Typed Treatment model (appointments are linked via Appointment.treatmentId)
model Treatment {
  id         String         @id @default(uuid())
  patient    String
  patientId  String?
  doctor     String
  doctorId   String?
  procedure  String
  cost       String
  status     TreatmentStatus @default(Pending)
  notes      String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  appointments Appointment[]
  invoices     Invoice[]

  @@index([status])
  @@index([patientId])
  @@index([doctorId])
}

// Medical Records
enum MedicalRecordStatus {
  Draft
  Final
}

model MedicalRecord {
  id         String              @id @default(uuid())
  patient    String
  patientId  String?
  type       String              // SOAP, Clinical Note, Treatment Plan, Consultation
  complaint  String?
  provider   String
  providerId String?
  date       DateTime            @default(now())
  status     MedicalRecordStatus @default(Final)
  notes      String?             @db.Text
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  @@index([patientId])
  @@index([status])
  @@index([date])
}

// Clinical Images
model ClinicalImage {
  id         String   @id @default(uuid())
  patient    String
  patientId  String?
  type       String
  imageUrl   String
  caption    String?  @db.Text
  date       DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([patientId])
  @@index([date])
}

// Dental Charts
model DentalChart {
  id         String   @id @default(uuid())
  patientId  String   @unique
  chartData  Json     // Stores the entire tooth chart as JSON
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([patientId])
}

enum UserRole {
  admin
  doctor
  receptionist
  patient
}

enum StaffStatus {
  Active
  Inactive
}

model Staff {
  id         String      @id @default(uuid())
  userId     String?     @unique
  user       User?       @relation(fields: [userId], references: [id])
  name       String
  role       String
  email      String       @unique
  phone      String
  schedule   String
  salary     String
  hireDate   DateTime
  status     StaffStatus  @default(Active)
  notes      String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([status])
  @@index([role])
}

// Inventory & Suppliers
enum SupplierStatus {
  Active
  Inactive
}

enum InventoryItemStatus {
  Normal
  LowStock
  OutOfStock
}

model Supplier {
  id           String         @id @default(uuid())
  name         String         @unique
  address      String?
  phone        String?
  email        String?
  category     String?
  paymentTerms String?
  rating       Float?
  status       SupplierStatus @default(Active)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  items        InventoryItem[]

  @@index([status])
}

model InventoryItem {
  id           String               @id @default(uuid())
  name         String
  category     String?
  supplierId   String?
  supplier     Supplier?            @relation(fields: [supplierId], references: [id])
  quantity     Int                  @default(0)
  minQuantity  Int                  @default(0)
  maxQuantity  Int                  @default(0)
  unitCost     Decimal              @db.Decimal(12,2)
  status       InventoryItemStatus  @default(Normal)
  expires      DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@index([status])
  @@index([category])
  @@index([quantity])
  @@index([expires])
}

model Invoice {
  id          String        @id @default(uuid())
  number      String        @unique
  patientId   String?
  patient     Patient?      @relation(fields: [patientId], references: [id])
  treatmentId String?
  treatment   Treatment?    @relation(fields: [treatmentId], references: [id])
  date        DateTime
  dueDate     DateTime?
  amount      Decimal        @db.Decimal(12,2)
  status      InvoiceStatus  @default(Draft)
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  items       InvoiceItem[]

  @@index([patientId])
  @@index([treatmentId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceItem {
  id         String   @id @default(uuid())
  invoiceId  String
  invoice    Invoice  @relation(fields: [invoiceId], references: [id])
  description String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(12,2)
  total       Decimal  @db.Decimal(12,2)
}

// Chat models for live chat functionality
enum ChatConversationStatus {
  Active
  Closed
  Archived
}

model ChatConversation {
  id            String                  @id @default(uuid())
  patientId     String?
  patientName   String
  patientEmail  String?
  staffId       String?
  staffName     String?
  status        ChatConversationStatus  @default(Active)
  lastMessageAt DateTime                @default(now())
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  messages      ChatMessage[]

  @@index([status])
  @@index([patientId])
  @@index([staffId])
  @@index([lastMessageAt])
}

model ChatMessage {
  id             String           @id @default(uuid())
  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderType     String           // 'patient' or 'staff'
  senderId       String?
  senderName     String
  message        String           @db.Text
  isRead         Boolean          @default(false)
  readAt         DateTime?
  createdAt      DateTime         @default(now())

  @@index([conversationId])
  @@index([isRead])
  @@index([createdAt])
}

model PatientSettings {
  id                    String   @id @default(uuid())
  patientId             String?  @unique
  patient               Patient? @relation(fields: [patientId], references: [id], onDelete: Cascade)
  userId                String   @unique
  emailNotifications    Boolean  @default(true)
  smsNotifications      Boolean  @default(true)
  appointmentReminders  Boolean  @default(true)
  promotionalEmails     Boolean  @default(false)
  language              String   @default("en")
  timezone              String   @default("Africa/Cairo")
  darkMode              Boolean  @default(false)
  twoFactorEnabled      Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@index([patientId])
}

model PortalContent {
  id          String   @id @default(uuid())
  type        String   // health_tips, promotions, welcome_message, etc.
  title       String?
  content     Json     // Flexible JSON content for different types
  active      Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([active])
}

model ClinicSettings {
  id                   String   @id @default("main")
  clinicName           String   @default("")
  phoneNumber          String   @default("")
  email                String   @default("")
  website              String   @default("")
  address              String   @default("")
  businessHours        String   @default("mon-fri-8-6")
  timezone             String   @default("eastern")
  appointmentDuration  String   @default("60")
  bookingLimit         String   @default("90")
  allowOnlineBooking   Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Notification {
  id              String              @id @default(uuid())
  userId          String
  type            NotificationType
  title           String
  message         String
  relatedId       String?             // ID of related entity (appointment, inventory, message, chat)
  relatedType     String?             // Type of related entity
  link            String?             // Navigation link when clicked
  isRead          Boolean             @default(false)
  readAt          DateTime?
  priority        NotificationPriority @default(NORMAL)
  metadata        Json?               // Additional data (patient name, stock level, etc.)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@index([type])
}

enum NotificationType {
  APPOINTMENT_PENDING
  APPOINTMENT_CONFIRMED
  APPOINTMENT_CANCELLED
  INVENTORY_LOW_STOCK
  INVENTORY_OUT_OF_STOCK
  MESSAGE_RECEIVED
  CHAT_MESSAGE
  SYSTEM
  REMINDER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}
