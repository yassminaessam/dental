generator client {
  provider = "prisma-client-js"
}

// Typed enums (new)
enum AppointmentStatus {
  Confirmed
  Pending
  Cancelled
  Completed
}

enum PatientStatus {
  Active
  Inactive
}

// New enum for treatments
enum TreatmentStatus {
  Pending
  InProgress
  Completed
}

enum InvoiceStatus {
  Draft
  Sent
  Paid
  Overdue
  Cancelled
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String
  firstName       String
  lastName        String
  role            UserRole
  permissions     String[]
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime?
  specialization  String?
  licenseNumber   String?
  employeeId      String?
  department      String?
  patientId       String?
  phone           String?   @unique
  address         String?
  profileImageUrl String?

  // Optional staff linkage for employees
  staff           Staff?
  
  // User notifications
  notifications   Notification[]
  
  // Password reset tokens
  passwordResets  PasswordReset[]
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)

  @@index([token])
  @@index([userId])
}

model CollectionDoc {
  id         String
  collection String
  data       Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@id([collection, id])
  @@index([collection])
}

// Typed Appointment model
model Appointment {
  id               String            @id @default(uuid())
  dateTime         DateTime
  patient          String
  patientId        String?
  patientEmail     String?
  patientPhone     String?
  doctor           String
  doctorId         String?
  type             String
  duration         String
  status           AppointmentStatus @default(Confirmed)
  treatmentId      String?
  treatment        Treatment?        @relation(fields: [treatmentId], references: [id])
  notes            String?
  bookedBy         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  reason           String?
  urgency          String?
  confirmedAt      DateTime?
  confirmedBy      String?
  rejectedAt       DateTime?
  rejectionReason  String?
  rejectedBy       String?

  @@index([dateTime])
  @@index([status])
  @@index([treatmentId])
}

model Patient {
  id                String        @id @default(uuid())
  name              String
  lastName          String
  email             String        @unique
  phone             String        @unique
  dob               DateTime
  lastVisit         DateTime?
  status            PatientStatus @default(Active)
  address           String?
  ecName            String?
  ecPhone           String?
  ecRelationship    String?
  insuranceProvider String?
  policyNumber      String?
  medicalHistory    Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  invoices          Invoice[]
  settings          PatientSettings?

  @@index([status])
  @@index([lastVisit])
}

// Typed Treatment model (appointments are linked via Appointment.treatmentId)
model Treatment {
  id         String         @id @default(uuid())
  patient    String
  patientId  String?
  doctor     String
  doctorId   String?
  procedure  String
  cost       String
  status     TreatmentStatus @default(Pending)
  notes      String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  appointments Appointment[]
  invoices     Invoice[]

  @@index([status])
  @@index([patientId])
  @@index([doctorId])
}

// Medical Records
enum MedicalRecordStatus {
  Draft
  Final
}

model MedicalRecord {
  id         String              @id @default(uuid())
  patient    String
  patientId  String?
  type       String              // SOAP, Clinical Note, Treatment Plan, Consultation
  complaint  String?
  provider   String
  providerId String?
  date       DateTime            @default(now())
  status     MedicalRecordStatus @default(Final)
  notes      String?             @db.Text
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  @@index([patientId])
  @@index([status])
  @@index([date])
}

// Clinical Images
model ClinicalImage {
  id          String   @id @default(uuid())
  patient     String
  patientId   String?
  type        String
  imageUrl    String
  caption     String?  @db.Text
  toothNumber Int?
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([patientId])
  @@index([date])
  @@index([toothNumber])
}

// Dental Charts
model DentalChart {
  id         String   @id @default(uuid())
  patientId  String   @unique
  chartData  Json     // Stores the entire tooth chart as JSON
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([patientId])
}

enum UserRole {
  admin
  doctor
  receptionist
  patient
}

enum StaffStatus {
  Active
  Inactive
}

model Staff {
  id         String      @id @default(uuid())
  userId     String?     @unique
  user       User?       @relation(fields: [userId], references: [id])
  name       String
  role       String
  email      String       @unique
  phone      String
  schedule   String
  salary     String
  hireDate   DateTime
  status     StaffStatus  @default(Active)
  notes      String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([status])
  @@index([role])
}

// Inventory & Suppliers
enum SupplierStatus {
  Active
  Inactive
}

enum InventoryItemStatus {
  Normal
  LowStock
  OutOfStock
}

enum MedicationStatus {
  InStock
  LowStock
  OutOfStock
}

enum PrescriptionStatus {
  Active
  Completed
}

enum PurchaseOrderStatus {
  Pending
  Shipped
  Delivered
  Cancelled
}

enum PharmacyTransactionType {
  Revenue
  Expense
}

enum PharmacyTransactionStatus {
  Pending
  Completed
}

model Supplier {
  id           String         @id @default(uuid())
  name         String         @unique
  address      String?
  phone        String?
  email        String?
  category     String?
  paymentTerms String?
  rating       Float?
  status       SupplierStatus @default(Active)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  items        InventoryItem[]
  purchaseOrders PurchaseOrder[]

  @@index([status])
}

model InventoryItem {
  id           String               @id @default(uuid())
  name         String
  category     String?
  supplierId   String?
  supplier     Supplier?            @relation(fields: [supplierId], references: [id])
  supplierName String?
  quantity     Int                  @default(0)
  minQuantity  Int                  @default(0)
  maxQuantity  Int                  @default(0)
  unitCost     Decimal              @db.Decimal(12,2)
  status       InventoryItemStatus  @default(Normal)
  expires      DateTime?
  location     String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  medications  Medication[]

  @@index([status])
  @@index([category])
  @@index([quantity])
  @@index([expires])

}

model Medication {
  id              String           @id @default(uuid())
  name            String
  fullName        String?
  strength        String?
  form            String?
  category        String?
  stock           Int              @default(0)
  unitPrice       Decimal          @db.Decimal(12, 2)
  expiryDate      DateTime?
  status          MedicationStatus @default(InStock)
  inventoryItemId String?
  inventoryItem   InventoryItem?   @relation(fields: [inventoryItemId], references: [id])
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  prescriptions   Prescription[]
  dispensings     PharmacyDispense[]

  @@index([status])
  @@index([category])
}

model Prescription {
  id                String             @id @default(uuid())
  patientId         String?
  patientName       String
  doctorId          String?
  doctorName        String
  medicationId      String?
  medication        Medication?        @relation(fields: [medicationId], references: [id])
  medicationName    String
  strength          String?
  dosage            String?
  instructions      String?
  duration          String?
  refills           Int                @default(0)
  status            PrescriptionStatus @default(Active)
  invoiceId         String?
  treatmentId       String?
  dispensedAt       DateTime?
  dispensedQuantity Int?
  totalAmount       Decimal?           @db.Decimal(12, 2)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  dispensings       PharmacyDispense[]

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
}

model PharmacyDispense {
  id             String    @id @default(uuid())
  prescriptionId String?
  prescription   Prescription? @relation(fields: [prescriptionId], references: [id])
  medicationId   String?
  medication     Medication? @relation(fields: [medicationId], references: [id])
  patientId      String?
  patientName    String
  doctorId       String?
  doctorName     String?
  quantity       Int
  unitPrice      Decimal   @db.Decimal(12, 2)
  totalAmount    Decimal   @db.Decimal(12, 2)
  invoiceId      String?
  treatmentId    String?
  notes          String?
  dispensedBy    String?
  dispensedAt    DateTime  @default(now())
  createdAt      DateTime  @default(now())

  @@index([prescriptionId])
  @@index([medicationId])
}

model PurchaseOrder {
  id               String               @id @default(uuid())
  supplierId       String?
  supplier         Supplier?            @relation(fields: [supplierId], references: [id])
  supplierName     String
  status           PurchaseOrderStatus  @default(Pending)
  total            Decimal              @db.Decimal(12, 2)
  orderDate        DateTime
  expectedDelivery DateTime?
  items            Json?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@index([supplierId])
  @@index([status])
}

model PharmacyTransaction {
  id               String                     @id @default(uuid())
  date             DateTime                   @default(now())
  description      String
  amount           Decimal                    @db.Decimal(12, 2)
  amountValue      Decimal                    @db.Decimal(12, 2)
  totalAmount      Decimal?                   @db.Decimal(12, 2)
  outstandingAmount Decimal?                  @db.Decimal(12, 2)
  type             PharmacyTransactionType
  category         String?
  status           PharmacyTransactionStatus  @default(Completed)
  paymentMethod    String?
  patientId        String?
  patientName      String?
  sourceId         String?
  sourceType       String?
  metadata         Json?
  auto             Boolean                    @default(false)
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt

  @@index([type])
  @@index([status])
  @@index([patientId])
}
model Invoice {
  id          String        @id @default(uuid())
  number      String        @unique
  patientId   String?
  patient     Patient?      @relation(fields: [patientId], references: [id])
  patientNameSnapshot String?
  patientPhoneSnapshot String?
  treatmentId String?
  treatment   Treatment?    @relation(fields: [treatmentId], references: [id])
  date        DateTime
  dueDate     DateTime?
  amount      Decimal        @db.Decimal(12,2)
  amountPaid  Decimal        @db.Decimal(12,2) @default(0)
  status      InvoiceStatus  @default(Draft)
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  items       InvoiceItem[]

  @@index([patientId])
  @@index([treatmentId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceItem {
  id         String   @id @default(uuid())
  invoiceId  String
  invoice    Invoice  @relation(fields: [invoiceId], references: [id])
  description String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(12,2)
  total       Decimal  @db.Decimal(12,2)
}

// Chat models for live chat functionality
enum ChatConversationStatus {
  Active
  Closed
  Archived
}

model ChatConversation {
  id            String                  @id @default(uuid())
  patientId     String?
  patientName   String
  patientEmail  String?
  staffId       String?
  staffName     String?
  status        ChatConversationStatus  @default(Active)
  lastMessageAt DateTime                @default(now())
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  messages      ChatMessage[]

  @@index([status])
  @@index([patientId])
  @@index([staffId])
  @@index([lastMessageAt])
}

model ChatMessage {
  id             String           @id @default(uuid())
  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderType     String           // 'patient' or 'staff'
  senderId       String?
  senderName     String
  message        String           @db.Text
  isRead         Boolean          @default(false)
  readAt         DateTime?
  createdAt      DateTime         @default(now())

  @@index([conversationId])
  @@index([isRead])
  @@index([createdAt])
}

model PatientSettings {
  id                    String   @id @default(uuid())
  patientId             String?  @unique
  patient               Patient? @relation(fields: [patientId], references: [id], onDelete: Cascade)
  userId                String   @unique
  emailNotifications    Boolean  @default(true)
  smsNotifications      Boolean  @default(true)
  appointmentReminders  Boolean  @default(true)
  promotionalEmails     Boolean  @default(false)
  language              String   @default("en")
  timezone              String   @default("Africa/Cairo")
  darkMode              Boolean  @default(false)
  twoFactorEnabled      Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@index([patientId])
}

model PortalContent {
  id          String   @id @default(uuid())
  type        String   // health_tips, promotions, welcome_message, etc.
  title       String?
  content     Json     // Flexible JSON content for different types
  active      Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([active])
}

model ClinicSettings {
  id                   String   @id @default("main")
  clinicName           String   @default("")
  phoneNumber          String   @default("")
  email                String   @default("")
  website              String   @default("")
  address              String   @default("")
  logoUrl              String?
  faviconUrl           String?
  businessHours        String   @default("mon-fri-8-6")
  weeklySchedule       Json?
  timezone             String   @default("eastern")
  appointmentDuration  String   @default("60")
  bookingLimit         String   @default("90")
  allowOnlineBooking   Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Notification {
  id              String              @id @default(uuid())
  userId          String
  type            NotificationType
  title           String
  message         String
  relatedId       String?             // ID of related entity (appointment, inventory, message, chat)
  relatedType     String?             // Type of related entity
  link            String?             // Navigation link when clicked
  isRead          Boolean             @default(false)
  readAt          DateTime?
  priority        NotificationPriority @default(NORMAL)
  metadata        Json?               // Additional data (patient name, stock level, etc.)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@index([type])
}

enum NotificationType {
  APPOINTMENT_PENDING
  APPOINTMENT_CONFIRMED
  APPOINTMENT_CANCELLED
  INVENTORY_LOW_STOCK
  INVENTORY_OUT_OF_STOCK
  MESSAGE_RECEIVED
  CHAT_MESSAGE
  SYSTEM
  REMINDER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Patient Messages/Communications
enum MessageType {
  Email
  SMS
  WhatsApp
  Call
}

enum MessageStatus {
  Sent
  Delivered
  Failed
  Queued
  Read
}

enum MessagePriority {
  low
  normal
  high
}

model PatientMessage {
  id          String          @id @default(uuid())
  patientId   String
  patientName String
  type        MessageType     @default(Email)
  subject     String
  content     String          @db.Text
  snippet     String?
  status      MessageStatus   @default(Queued)
  priority    MessagePriority @default(normal)
  sentAt      DateTime?
  readAt      DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([patientId])
  @@index([status])
  @@index([type])
}

// Insurance Claims
enum InsuranceClaimStatus {
  Processing
  Approved
  Denied
  Pending
}

model InsuranceClaim {
  id              String                @id @default(uuid())
  patientId       String
  patientName     String
  insuranceProvider String
  policyNumber    String?
  procedure       String
  procedureCode   String?
  amount          Decimal               @db.Decimal(12, 2)
  approvedAmount  Decimal?              @db.Decimal(12, 2)
  status          InsuranceClaimStatus  @default(Pending)
  submitDate      DateTime              @default(now())
  responseDate    DateTime?
  notes           String?               @db.Text
  treatmentId     String?
  invoiceId       String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([patientId])
  @@index([status])
  @@index([submitDate])
}

// Referrals
enum ReferralStatus {
  pending
  scheduled
  completed
  cancelled
}

enum ReferralUrgency {
  routine
  urgent
  emergency
}

model Referral {
  id            String          @id @default(uuid())
  patientId     String
  patientName   String
  specialty     String
  specialist    String
  reason        String          @db.Text
  urgency       ReferralUrgency @default(routine)
  status        ReferralStatus  @default(pending)
  referringDoctor String?
  referringDoctorId String?
  referralDate  DateTime        @default(now())
  appointmentDate DateTime?
  notes         String?         @db.Text
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([patientId])
  @@index([status])
  @@index([referralDate])
}

// Tooth Image Links (linking clinical images to specific teeth)
model ToothImageLink {
  id            String   @id @default(uuid())
  patientId     String
  patientName   String
  imageId       String
  toothNumber   Int
  condition     String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([patientId])
  @@index([imageId])
  @@index([toothNumber])
}

// Lab Management
enum LabCaseStatus {
  Draft
  Submitted
  InProgress
  QualityCheck
  Completed
  Delivered
  Cancelled
}

enum LabCasePriority {
  Low
  Normal
  High
  Urgent
}

model Lab {
  id           String      @id @default(uuid())
  name         String      @unique
  address      String?
  phone        String?
  email        String?
  contactName  String?
  specialty    String?     // Crown & Bridge, Orthodontics, Implants, etc.
  rating       Float?
  isActive     Boolean     @default(true)
  notes        String?     @db.Text
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  cases        LabCase[]

  @@index([isActive])
}

model LabCase {
  id              String          @id @default(uuid())
  caseNumber      String          @unique
  labId           String?
  lab             Lab?            @relation(fields: [labId], references: [id])
  labName         String?
  patientId       String?
  patientName     String
  doctorId        String?
  doctorName      String
  treatmentId     String?
  
  // Case Details
  caseType        String          // Crown, Bridge, Denture, Implant, Orthodontic, etc.
  toothNumbers    String?         // Comma-separated tooth numbers
  shade           String?         // Tooth shade
  material        String?         // Material type (Zirconia, PFM, etc.)
  description     String?         @db.Text
  instructions    String?         @db.Text
  
  // Dates & Tracking
  status          LabCaseStatus   @default(Draft)
  priority        LabCasePriority @default(Normal)
  requestDate     DateTime        @default(now())
  dueDate         DateTime?
  sentToLabDate   DateTime?
  receivedDate    DateTime?
  deliveredDate   DateTime?
  
  // Financial
  estimatedCost   Decimal?        @db.Decimal(12, 2)
  actualCost      Decimal?        @db.Decimal(12, 2)
  invoiceId       String?
  
  // Tracking
  notes           String?         @db.Text
  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Related
  attachments     LabCaseAttachment[]
  updates         LabCaseUpdate[]

  @@index([labId])
  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@index([priority])
  @@index([requestDate])
  @@index([dueDate])
}

model LabCaseAttachment {
  id          String   @id @default(uuid())
  caseId      String
  case        LabCase  @relation(fields: [caseId], references: [id], onDelete: Cascade)
  fileName    String
  fileUrl     String
  fileType    String   // image, document, prescription, scan, etc.
  fileSize    Int?
  description String?
  uploadedBy  String?
  createdAt   DateTime @default(now())

  @@index([caseId])
  @@index([fileType])
}

model LabCaseUpdate {
  id          String        @id @default(uuid())
  caseId      String
  case        LabCase       @relation(fields: [caseId], references: [id], onDelete: Cascade)
  status      LabCaseStatus
  message     String?       @db.Text
  updatedBy   String?
  isSharedWithLab Boolean   @default(false)
  createdAt   DateTime      @default(now())

  @@index([caseId])
  @@index([createdAt])
}
